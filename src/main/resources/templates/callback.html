<!DOCTYPE html>
<html>
<head><meta charset="UTF-8"><title>PKCE Callback</title></head>
<body>
<p>Authorizing...</p>
<script>
(async function handleCallback() {
  const params = new URLSearchParams(window.location.search);
  const code = params.get('code');
  const state = params.get('state');
  if (!code) {
    document.body.textContent = '授权失败：缺少 code';
    return;
  }
  const verifier = sessionStorage.getItem('pkce_code_verifier');
  if (!verifier) {
    document.body.textContent = '授权失败：code_verifier 丢失';
    return;
  }
  try {
    const tokenResp = await fetch('/token', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ code, state, code_verifier: verifier })
    }).then(r => r.json());
    if (tokenResp.error) throw new Error(tokenResp.error);
    const userInfo = await fetch('/userinfo', {
      headers: { 'Authorization': 'Bearer ' + tokenResp.access_token }
    }).then(r => r.json());
    sessionStorage.removeItem('pkce_code_verifier');
    document.body.innerHTML = '<h1>欢迎, ' + userInfo.name + '</h1>';
  } catch (err) {
    document.body.textContent = '授权失败：' + err.message;
  }
})();
</script>
</body>
</html>